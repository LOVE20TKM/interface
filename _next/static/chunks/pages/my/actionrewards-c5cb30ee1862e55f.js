try{!function(){var e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[n]="eccefb0e-e593-4097-8a0b-9ea466309033",e._sentryDebugIdIdentifier="sentry-dbid-eccefb0e-e593-4097-8a0b-9ea466309033")}()}catch(e){}(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[943],{51436:function(e,n,t){(window.__NEXT_P=window.__NEXT_P||[]).push(["/my/actionrewards",function(){return t(17762)}])},74598:function(e,n,t){"use strict";t.d(n,{Z:function(){return r}});var r=(0,t(31134).Z)("Info",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 16v-4",key:"1dtifu"}],["path",{d:"M12 8h.01",key:"e9boi3"}]])},64777:function(e,n,t){"use strict";var r=t(85893);n.Z=function(e){var n=e.title;return(0,r.jsx)("div",{className:"flex justify-between items-center",children:(0,r.jsx)("h1",{className:"text-lg font-bold",children:n})})}},42083:function(e,n,t){"use strict";var r=t(85893),a=t(23432);n.Z=function(){return(0,r.jsx)(a.Z,{className:"mx-auto h-4 w-4 animate-spin text-greyscale-500"})}},17762:function(e,n,t){"use strict";t.r(n),t.d(n,{default:function(){return J}});var r=t(11010),a=t(72253),o=t(14932),c=t(91309),i=t(97582),s=t(85893),d=t(67294),u=t(86501),l=t(42130),f=t(11163),h=t(93778),g=t(7208),v=t(93950),x=t(7399),m=t(59271),b=t(4586),y=t(67516),j=t(98482),S=t(43637),p=t(97995),I=t(45631),w=function(e,n){return"love20_score_cache_".concat(e.toLowerCase(),"_").concat(n.toLowerCase())},N=function(e,n){try{var t=localStorage.getItem(w(e,n));return t?JSON.parse(t):{}}catch(e){return{}}},_=function(e,n,t){try{var r=N(e,n);Object.entries(t).forEach(function(e){var n=(0,c._)(e,2),t=n[0],a=n[1];Object.entries(a).forEach(function(e){var n=(0,c._)(e,2),a=n[0],o=n[1];r["".concat(t,"_").concat(a)]=o})}),localStorage.setItem(w(e,n),JSON.stringify(r))}catch(e){console.error("写入得分缓存失败:",e)}},B=function(e){var n=e.account,t=e.tokenAddress,o=e.actionRoundPairs,s=e.enabled,u=void 0===s||s,l=(0,d.useMemo)(function(){if(!u||0===o.length||!n||!t)return{validActionRoundPairs:[],actionRoundPairsKey:"",cachedScores:{},uncachedPairs:[]};var e=N(n,t),r={},a=[];o.forEach(function(n){var t=e["".concat(n.actionId.toString(),"_").concat(n.round.toString())];if(void 0!==t){var o=n.actionId.toString(),c=n.round.toString();r[o]||(r[o]={}),r[o][c]=t}else a.push(n)});var c=o.map(function(e){return"".concat(e.actionId.toString(),"_").concat(e.round.toString())}).join("|");return console.log("缓存命中: ".concat(Object.keys(e).length," 条, 需要请求: ").concat(a.length," 条")),{validActionRoundPairs:o,actionRoundPairsKey:c,cachedScores:r,uncachedPairs:a}},[o,u,n,t]),f=l.validActionRoundPairs,h=l.actionRoundPairsKey,g=l.cachedScores,v=l.uncachedPairs,x=(0,d.useMemo)(function(){return u&&0!==v.length&&t?v.map(function(e){var n=e.actionId,r=e.round;return{address:"0xACea4f086BE05BeA47f3A56788FA3919C7f40799",abi:j.S,functionName:"randomAccounts",args:[t,r,n]}}):[]},[t,v,u]),m=(0,y.N)({contracts:x,query:{enabled:u&&x.length>0}}),w=m.data,B=m.isLoading,E=m.error,P=m.isSuccess;console.log("randomAccountsData",w);var k=(0,c._)((0,d.useState)({}),2),M=k[0],L=k[1],A=(0,c._)((0,d.useState)(!1),2),C=A[0],R=A[1],O=(0,c._)((0,d.useState)(null),2),Z=O[0],J=O[1],q=(0,c._)((0,d.useState)(!1),2),D=q[0],F=q[1];(0,d.useEffect)(function(){var e;u&&w&&P&&0!==v.length&&t&&n&&(e=(0,r._)(function(){var e,r,o,c,s;return(0,i.Jh)(this,function(d){switch(d.label){case 0:R(!0),J(null),L({}),e={},r={},d.label=1;case 1:d.trys.push([1,6,,7]),o=function(o){var c,s,d,u,l,f,h,g,x,m,y,j,N,_,B,E,P,k;return(0,i.Jh)(this,function(i){switch(i.label){case 0:if(s=(c=v[o]).actionId,d=c.round,(null==(u=w[o])?void 0:u.status)!=="success")return[3,2];return l=u.result,(f=(0,b._)(l)).includes(n)||f.push(n),h=f.map(function(e){return{address:"0x547b4a36980Ec030fBfC0162eE4B4904d9Cc0Da9",abi:S.w,functionName:"scoreByActionIdByAccount",args:[t,d,s,e]}}),console.log("正在加载 actionId=".concat(s,", round=").concat(d," 的分数数据，共 ").concat(h.length," 个账户...")),[4,(0,p.J)(I.v,{contracts:h})];case 1:g=i.sent(),x="".concat(s.toString(),"_").concat(d.toString()),m={},y=!1,g.forEach(function(e,n){if((null==e?void 0:e.status)==="success"){var t=f[n],r=e.result||BigInt(0);m[t]=r}else y=!0,console.warn("获取账户 ".concat(f[n]," 的得分失败:"),null==e?void 0:e.error)}),j=void 0!==m[n],e[x]={actionId:s,round:d,accountScores:m},!y&&j?(N=Object.values(m).reduce(function(e,n){return n>e?n:e},BigInt(0)),_=m[n]||BigInt(0),B="0",N>BigInt(0)&&_>BigInt(0)&&(E=_*BigInt(100)/N,B=(_*BigInt(100)%N*BigInt(2)>=N?Number(E)+1:Number(E)).toString()),P=s.toString(),k=d.toString(),r[P]||(r[P]={}),r[P][k]=B,console.log("完成加载 actionId=".concat(s,", round=").concat(d,"，进度: ").concat(o+1,"/").concat(v.length))):console.warn("跳过缓存 actionId=".concat(s,", round=").concat(d,": ")+"hasFailedRequest=".concat(y,", hasTargetAccountScore=").concat(j)),L((0,a._)({},e)),i.label=2;case 2:return[2]}})},c=0,d.label=2;case 2:if(!(c<v.length))return[3,5];return[5,(0,i.XA)(o(c))];case 3:d.sent(),d.label=4;case 4:return c++,[3,2];case 5:return Object.keys(r).length>0&&(_(n,t,r),console.log("得分数据已写入缓存")),F(!0),R(!1),[3,7];case 6:return console.error("分批加载分数时出错:",s=d.sent()),J(s),R(!1),F(!1),[3,7];case 7:return[2]}})}),function(){return e.apply(this,arguments)})()},[u,t,n,h,P]);var K=(0,d.useMemo)(function(){if(!u||0===f.length)return{scores:{},isLoading:!1,hasError:!1,allLoaded:!0};if(E||Z)return{scores:{},isLoading:!1,hasError:!0,allLoaded:!1};if(B)return{scores:g,isLoading:v.length>0,hasError:!1,allLoaded:!1};var e={};Object.values(M).forEach(function(t){var r=t.actionId,a=t.round,o=t.accountScores,c=Object.values(o).reduce(function(e,n){return n>e?n:e},BigInt(0)),i=o[n]||BigInt(0),s="0";if(c>BigInt(0)&&i>BigInt(0)){var d=i*BigInt(100)/c;s=(i*BigInt(100)%c*BigInt(2)>=c?Number(d)+1:Number(d)).toString()}var u=r.toString(),l=a.toString();e[u]||(e[u]={}),e[u][l]=s});var t=(0,a._)({},g);Object.entries(e).forEach(function(e){var n=(0,c._)(e,2),r=n[0],a=n[1];t[r]||(t[r]={}),Object.entries(a).forEach(function(e){var n=(0,c._)(e,2),a=n[0],o=n[1];t[r][a]=o})});var r=0===v.length||D&&!C;return{scores:t,isLoading:C,hasError:!1,allLoaded:r}},[u,f,n,B,C,E,Z,D,w,P,M,g,v]);return{scores:K.scores,isLoading:K.isLoading,hasError:K.hasError,allLoaded:K.allLoaded}},E=t(73591),P=t(83494),k=t(64777),M=t(42083),L=t(44576),A=t(27245),C=t(74598),R=t(26858),O=t(6743),Z=BigInt(6),J=function(){var e,n=(0,f.useRouter)(),t=((0,d.useContext)(h.M)||{}).token,b=(0,l.m)().address,y=(0,m.Bk)(),j=y.currentRound,S=y.isPending,p=(0,g.N6)(null==t?void 0:t.address,b,Z),I=p.rewards,w=p.isPending,N=p.error,_=(0,v.dB)(null==t?void 0:t.address,b),J=_.joinedActions,q=_.isPending,D=_.error,F=(0,d.useMemo)(function(){if(!J||!I||void 0===j)return[];var e=j>Z?j-Z-BigInt(1):BigInt(0),n=j-BigInt(1),t=new Map,r=!0,a=!1,o=void 0;try{for(var c,i=I[Symbol.iterator]();!(r=(c=i.next()).done);r=!0){var s=c.value;if(!(s.reward<=BigInt(0))){var d=s.actionId.toString(),u=s.round.toString();t.has(d)||t.set(d,new Map),t.get(d).set(u,s)}}}catch(e){a=!0,o=e}finally{try{r||null==i.return||i.return()}finally{if(a)throw o}}var l=[],f=!0,h=!1,g=void 0;try{for(var v,x=J[Symbol.iterator]();!(f=(v=x.next()).done);f=!0){for(var m=v.value,b=m.action.head.id,y=b.toString(),S=t.get(y),p=[],w=n;w>=e;w--){var N=w.toString(),_=null==S?void 0:S.get(N);_?p.push(_):p.push({actionId:b,round:w,reward:BigInt(0),isMinted:!1,notSelected:!0})}l.push({action:m,rewards:p})}}catch(e){h=!0,g=e}finally{try{f||null==x.return||x.return()}finally{if(h)throw g}}return l.sort(function(e,n){return BigInt(e.action.action.head.id)>BigInt(n.action.action.head.id)?-1:1}),l},[J,I,j]),K=(0,d.useMemo)(function(){if(!I||0===I.length)return{actionRoundPairs:[],enabled:!1};var e=I.filter(function(e){return e.reward>BigInt(0)}).map(function(e){return{actionId:e.actionId,round:e.round}}).sort(function(e,n){return e.round>n.round?-1:1});return{actionRoundPairs:e,enabled:e.length>0}},[I]),T=B({account:b,tokenAddress:null==t?void 0:t.address,actionRoundPairs:K.actionRoundPairs,enabled:!1}),X=T.scores,z=T.isLoading;T.hasError;var V=(0,x.Rb)(),H=V.mintActionReward,G=V.isPending,Q=V.isConfirming,U=V.isConfirmed,W=V.writeError,Y=(0,c._)((0,d.useState)(null),2),$=Y[0],ee=Y[1],en=(0,c._)((0,d.useState)(new Set),2),et=en[0],er=en[1];(0,d.useEffect)(function(){if(U){if(u.ZP.success("铸造成功"),$){var e="".concat($.actionId.toString(),"-").concat($.round.toString());er(function(n){var t=new Set(n);return t.add(e),t})}(null==t?void 0:t.address)&&b&&(0,O.j)(b,t.address,!1)}},[U,$,null==t?void 0:t.address,b]),(0,d.useEffect)(function(){er(new Set)},[null==t?void 0:t.address,b]),(0,d.useEffect)(function(){if((null==t?void 0:t.address)&&b&&!w&&I&&!I.some(function(e){return e.reward>BigInt(0)&&!e.isMinted})){var e=(0,O.FP)(b,t.address);if(null==e?void 0:e.needMinted){var n=(0,O.iO)(b,t.address);localStorage.removeItem(n),(0,O.j)(b,t.address,!1)}}},[null==t?void 0:t.address,b,w,I]);var ea=(e=(0,r._)(function(e,n){return(0,i.Jh)(this,function(r){switch(r.label){case 0:if(!((null==t?void 0:t.address)&&b))return[3,2];return ee({actionId:n,round:e}),[4,H(t.address,e,n)];case 1:r.sent(),r.label=2;case 2:return[2]}})}),function(n,t){return e.apply(this,arguments)}),eo=(0,d.useMemo)(function(){return F?F.map(function(e){return(0,o._)((0,a._)({},e),{rewards:e.rewards.map(function(n){var t,r="".concat(BigInt(e.action.action.head.id).toString(),"-").concat(n.round.toString()),c=e.action.action.head.id.toString(),i=n.round.toString(),s=null==X?void 0:null===(t=X[c])||void 0===t?void 0:t[i],d=z&&!s;return(0,o._)((0,a._)({},n),{isMinted:et.has(r)||n.isMinted,score:s||"0.0",isScoreLoading:d,notSelected:n.notSelected})})})}):[]},[F,et,X,z]),ec=(0,E.S)().handleContractError;return(0,d.useEffect)(function(){N&&ec(N,"dataViewer"),D&&ec(D,"dataViewer"),W&&ec(W,"mint")},[N,D,W,ec]),(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(P.Z,{title:"行动激励",showBackButton:!0}),(0,s.jsxs)("main",{className:"flex-grow",children:[t?(0,s.jsxs)("div",{className:"flex flex-col space-y-6 p-4",children:[(0,s.jsxs)("div",{className:"flex justify-between items-center",children:[(0,s.jsx)(k.Z,{title:"铸造行动激励"}),(0,s.jsx)("button",{onClick:function(){return n.push("/my/queryaction?symbol=".concat(null==t?void 0:t.symbol))},className:"text-secondary hover:text-secondary/80 text-sm bg-transparent border-none cursor-pointer",children:"查看已退出行动激励\xa0>>"})]}),(0,s.jsx)("div",{className:"bg-red-50 border border-red-200 rounded-lg p-3 text-red-500 text-sm",children:(0,s.jsxs)("div",{className:"flex items-start gap-2",children:[(0,s.jsx)(C.Z,{className:"w-4 h-4 mt-0.5 flex-shrink-0"}),(0,s.jsxs)("div",{children:[(0,s.jsx)("span",{className:"font-medium",children:"小贴士："}),(0,s.jsx)("br",{}),"如果对激励打分有疑问，可以",(0,s.jsx)("br",{}),"1. 仔细阅读行动打分规则，检查是否按要求打卡；",(0,s.jsx)("br",{}),"2. 请教周围的治理者或志愿者；"]})]})}),w||q||S?(0,s.jsx)(M.Z,{}):eo.length>0?eo.map(function(e){return(0,s.jsxs)("div",{className:"border border-gray-100 rounded-lg p-4 shadow-sm",children:[(0,s.jsx)("div",{className:"flex items-center mb-3",children:(0,s.jsxs)("div",{className:"flex items-baseline  mr-2",children:[(0,s.jsx)("span",{className:"text-greyscale-500",children:"No."}),(0,s.jsx)("span",{className:"text-secondary text-xl font-bold mr-2",children:String(e.action.action.head.id)}),(0,s.jsx)("span",{className:"font-bold text-greyscale-800",children:"".concat(e.action.action.body.title)})]})}),e.rewards.length>0?(0,s.jsx)(s.Fragment,{children:(0,s.jsxs)("table",{className:"table w-full table-auto",children:[(0,s.jsx)("thead",{children:(0,s.jsxs)("tr",{className:"border-b border-gray-100",children:[(0,s.jsx)("th",{className:"text-left px-0",children:"轮次"}),(0,s.jsx)("th",{className:"text-center",children:"可铸造激励"}),(0,s.jsx)("th",{className:"text-center",children:"操作"})]})}),(0,s.jsx)("tbody",{children:e.rewards.map(function(n,r){return(0,s.jsxs)("tr",{className:r===e.rewards.length-1?"border-none":"border-b border-gray-100",children:[(0,s.jsx)("td",{className:"px-1",children:(0,R.cK)(n.round,t).toString()}),(0,s.jsx)("td",{className:"text-center px-1",children:n.notSelected?(0,s.jsx)("span",{className:"text-greyscale-500",children:"未抽中"}):(0,R.LH)(n.reward||BigInt(0))}),(0,s.jsx)("td",{className:"text-center px-1",children:n.notSelected?(0,s.jsx)("span",{className:"text-greyscale-500",children:"-"}):n.reward>BigInt(0)&&!n.isMinted?(0,s.jsx)(A.z,{variant:"outline",size:"sm",className:"text-secondary border-secondary",onClick:function(){return ea(n.round,BigInt(e.action.action.head.id))},disabled:G||Q,children:"铸造"}):n.isMinted?(0,s.jsx)("span",{className:"text-greyscale-500",children:"已铸造"}):(0,s.jsx)("span",{className:"text-greyscale-500",children:"-"})})]},"".concat(e.action.action.head.id,"-").concat(n.round.toString()))})})]})}):(0,s.jsxs)("div",{className:"text-center text-greyscale-500 py-4",children:["该行动最近 ",Z.toString()," 轮没有获得激励"]}),(0,s.jsx)("div",{className:"text-center",children:(0,s.jsx)("button",{onClick:function(){return n.push("/my/rewardsofaction?id=".concat(e.action.action.head.id))},className:"text-secondary hover:text-secondary/80 underline text-sm bg-transparent border-none cursor-pointer",children:"查看更多激励 >>"})})]},e.action.action.head.id)}):(0,s.jsx)("div",{className:"text-center text-greyscale-500 py-8",children:"没有参与任何行动"})]}):(0,s.jsx)(M.Z,{}),(0,s.jsx)(L.Z,{isLoading:G||Q,text:G?"提交交易...":"确认交易..."})]})]})}},67516:function(e,n,t){"use strict";t.d(n,{N:function(){return l}});var r=t(72253),a=t(14932),o=t(97995),c=t(36100),i=t(67294),s=t(95159),d=t(39360),u=t(78942);function l(){var e,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=n.contracts,l=void 0===t?[]:t,f=n.query,h=void 0===f?{}:f,g=(0,u.Z)(n),v=(0,d.x)({config:g}),x=function(e,n={}){return{async queryFn({queryKey:t}){let r=[],a=t[1].contracts.length;for(let e=0;e<a;e++){let a=t[1].contracts[e],o=(n.contracts?.[e]).abi;r.push({...a,abi:o})}let{scopeKey:c,...i}=t[1];return(0,o.J)(e,{...i,contracts:r})},queryKey:function(e={}){let n=[];for(let t of e.contracts??[]){let{abi:r,...a}=t;n.push({...a,chainId:a.chainId??e.chainId})}return["readContracts",(0,c.OP)({...e,contracts:n})]}(n)}}(g,(0,a._)((0,r._)({},n),{chainId:v})),m=(0,i.useMemo)(function(){var e,n=!1,t=!0,r=!1,a=void 0;try{for(var o,c=l[Symbol.iterator]();!(t=(o=c.next()).done);t=!0){var i=o.value,s=i.abi,d=i.address,u=i.functionName;if(!s||!d||!u){n=!1;break}n=!0}}catch(e){r=!0,a=e}finally{try{t||null==c.return||c.return()}finally{if(r)throw a}}return!!(n&&(null===(e=h.enabled)||void 0===e||e))},[l,h.enabled]);return(0,s.aM)((0,a._)((0,r._)({},x,h),{enabled:m,structuralSharing:null!==(e=h.structuralSharing)&&void 0!==e?e:c.if}))}}},function(e){e.O(0,[8501,4463,3494,3591,3950,9271,7399,2888,9774,179],function(){return e(e.s=51436)}),_N_E=e.O()}]);